<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Quadro de Obras ‚Äî Multiusu√°rio</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üèóÔ∏è</text></svg>">
  <link rel="stylesheet" href="style.css" />
  <!-- Leaflet CSS para o mapa -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script>
    // Verificar autentica√ß√£o ANTES de carregar a p√°gina
    (function() {
      const token = localStorage.getItem('token');
      if (!token) {
        window.location.replace('/login.html');
      }
    })();
    window.APP_VERSION='v1.0.9';
  </script>
</head>
<body>
  <header>
    <h1>üõ†Ô∏è Quadro de Acompanhamento das Obras</h1>
    <div style="display: flex; align-items: center; gap: 20px; margin-left: auto;">
      <div>
        <label for="projectSelect">Obra:</label>
        <select id="projectSelect"></select>
      </div>
      <a href="/visao-agregada.html" style="color: #9b59b6; text-decoration: none; font-weight: 500;">üéØ Vis√£o Agregada</a>
      <a href="/dashboard.html" style="color: #e67e22; text-decoration: none; font-weight: 500;">üìä Dashboard</a>
      <a href="/calendar.html" style="color: #f39c12; text-decoration: none; font-weight: 500;">üìÖ Calend√°rio</a>
      <a href="/settings.html" style="color: #3498db; text-decoration: none;">‚öôÔ∏è Configura√ß√µes</a>
      <button onclick="logout()" style="background: #e74c3c; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 14px; transition: background 0.3s;" onmouseover="this.style.background='#c0392b'" onmouseout="this.style.background='#e74c3c'">
        üö™ Sair
      </button>
    </div>
  </header>

  <div class="wrap">
    <aside>
      <div style="margin-bottom: 10px;">
        <h3 style="margin: 0 0 8px 0;">Obras</h3>
        <div style="display: flex; flex-direction: column; gap: 6px;">
          <input 
            type="text" 
            id="searchFilterAside" 
            placeholder="üîç Buscar obra..." 
            style="font-size: 12px; padding: 6px 8px; width: 100%; border: 1px solid #cbd5e1; border-radius: 4px;"
          />
          <select id="storeFilterAside" style="font-size: 12px; padding: 6px 8px; width: 100%;">
            <option value="all">üìç Todas lojas</option>
          </select>
          <select id="statusFilterAside" style="font-size: 12px; padding: 6px 8px; width: 100%;">
            <option value="all">üìä Todos status</option>
          </select>
          <select id="categoryFilterAside" style="font-size: 12px; padding: 6px 8px; width: 100%;">
            <option value="all">üìÅ Todas categorias</option>
            <option value="nova">üèóÔ∏è Novas Obras</option>
            <option value="reforma">üîß Reformas</option>
          </select>
          <label style="font-size: 11px; color: #94a3b8; cursor: pointer; display: flex; align-items: center; gap: 4px; padding: 4px 0;">
            <input type="checkbox" id="showArchivedCheckbox" style="cursor: pointer;">
            Mostrar arquivados
          </label>
        </div>
      </div>
      <div id="projectsList"></div>
      <div class="aside-actions">
        <button id="btnNewProjectAside" class="primary">+ Nova obra</button>
      </div>
    </aside>

    <main id="board">
      <!-- NOVA COLUNA: Detalhes da Obra -->
      <div class="col details-col" data-status="__DETAILS__">
        <h2>Detalhes da Obra</h2>
        
        <!-- Observa√ß√µes (Edit√°vel) - MOVIDO PARA O TOPO -->
        <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #95a5a6; font-size: 11px;">Observa√ß√µes:</label>
        <textarea id="projectDetails" placeholder="Adicione observa√ß√µes sobre a obra..."></textarea>
        <div style="margin-top: 10px; margin-bottom: 15px; display: flex; gap: 8px; align-items: center;">
          <button id="btnSaveDetails" onclick="saveProjectDetails()" 
            style="background: #10b981; color: white; border: none; padding: 8px 16px; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
            üíæ Salvar Altera√ß√µes
          </button>
          <span id="saveStatus" style="font-size: 11px; color: #94a3b8;"></span>
        </div>
        
        <hr style="margin: 12px 0; border: none; border-top: 1px solid #34495e;">
        
        <!-- Informa√ß√µes Fixas (Somente Leitura) -->
        <div id="project-info-display">
          <div class="info-field">
            <label>Cliente:</label>
            <span id="detail-client">-</span>
          </div>
          <div class="info-field">
            <label>Loja:</label>
            <span id="detail-store">-</span>
          </div>
          <div class="info-field">
            <label>Cidade:</label>
            <span id="detail-city">-</span>
          </div>
          <div class="info-field">
            <label>Status:</label>
            <span id="detail-status">-</span>
          </div>
          <div class="info-field">
            <label>Categoria:</label>
            <span id="detail-category">-</span>
          </div>
          <div class="info-field">
            <label>Integradora:</label>
            <span id="detail-integrator">-</span>
          </div>
          <div class="info-field">
            <label>Montador:</label>
            <span id="detail-assembler">-</span>
          </div>
          <div class="info-field">
            <label>Previs√£o In√≠cio Montagem:</label>
            <span id="detail-assembler-start">-</span>
          </div>
          <div class="info-field">
            <label>Eletricista:</label>
            <span id="detail-electrician">-</span>
          </div>
          <div class="info-field">
            <label>Previs√£o In√≠cio El√©trica:</label>
            <span id="detail-electrician-start">-</span>
          </div>
          <div class="info-field">
            <label>Previs√£o In√≠cio:</label>
            <span id="detail-start-date">-</span>
          </div>
          <div class="info-field">
            <label>Previs√£o Entrega:</label>
            <span id="detail-delivery">-</span>
          </div>
          <div class="info-field">
            <label>Localiza√ß√£o:</label>
            <span id="detail-location">-</span>
            <button onclick="openDetailLocationInMaps()" style="margin-left: 8px; padding: 4px 8px; background: #4285f4; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;" title="Abrir no Google Maps">
              üìç Maps
            </button>
          </div>
        </div>
        
        <hr style="margin: 12px 0; border: none; border-top: 1px solid #34495e;">
        
        <!-- Se√ß√£o GSI -->
        <div class="gsi-section" style="background: #1e293b; padding: 8px; border-radius: 6px; margin-bottom: 12px;">
          <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #3b82f6; font-size: 11px;">üöö ENTREGA GSI</label>
          <div class="gsi-fields" style="display: flex; flex-direction: column; gap: 8px;">
            <div class="info-field" style="border: none; padding: 4px 0;">
              <label style="color: #94a3b8; font-size: 10px;">Data Prevista:</label>
              <span id="detail-gsi-forecast">-</span>
            </div>
            <div class="info-field" style="border: none; padding: 4px 0;">
              <label style="color: #94a3b8; font-size: 10px;">Data Efetiva:</label>
              <div style="display: flex; align-items: center; gap: 8px;">
                <span id="detail-gsi-actual" style="flex: 1;">-</span>
                <button id="btn-validate-gsi" 
                  style="background: #10b981; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 10px; cursor: pointer; display: none;">
                  ‚úì Validar Chegada
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-resizer" data-resize="0"></div>

      <div class="col" data-status="Criado">
        <h2>Criado</h2>
        <div class="tasks" id="col-criado"></div>
        <div class="add-area">
          <input id="input-criado" placeholder="Nova tarefa..." />
          <button id="btnAddCriado" class="primary">Adicionar</button>
        </div>
      </div>

      <div class="col-resizer" data-resize="1"></div>

      <div class="col" data-status="Em separa√ß√£o">
        <h2>Em separa√ß√£o</h2>
        <div class="tasks" id="col-em"></div>
      </div>

      <div class="col-resizer" data-resize="2"></div>

      <div class="col" data-status="Pendencia">
        <h2>Pend√™ncia</h2>
        <div class="tasks" id="col-pend"></div>
      </div>

      <div class="col-resizer" data-resize="3"></div>

      <div class="col" data-status="Em romaneio">
        <h2>Em romaneio</h2>
        <div class="tasks" id="col-romaneio"></div>
      </div>

      <div class="col-resizer" data-resize="4"></div>

      <div class="col" data-status="Entregue">
        <h2>Entregue</h2>
        <div class="tasks" id="col-entregue"></div>
      </div>
    </main>
  </div>

  <footer>
    <div class="version-line">v<span id="app-version">...</span></div>
    <div class="date-line">Atualizado em <span id="app-date">...</span></div>
  </footer>

  <!-- Modal: Nova Obra -->
  <div class="modal" id="project-modal">
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <h2>Nova Obra</h2>
        <button class="close-modal" onclick="closeProjectModal()">&times;</button>
      </div>
      <form id="project-form">
        <div class="form-row">
          <div class="form-group">
            <label for="project-client">Cliente *</label>
            <input type="text" id="project-client" required placeholder="Nome do cliente" />
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label for="project-store">Loja *</label>
            <select id="project-store" required>
              <option value="">Selecione...</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="project-city">Cidade</label>
            <input type="text" id="project-city" placeholder="Cidade da obra" />
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label for="project-status">Status *</label>
            <select id="project-status" required>
              <option value="">Selecione...</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="project-category">Categoria *</label>
            <select id="project-category" required>
              <option value="nova">üèóÔ∏è Nova Obra</option>
              <option value="reforma">üîß Reforma</option>
            </select>
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label for="project-integrator">Integradora</label>
            <select id="project-integrator" onchange="handleNewOption('integrator')">
              <option value="">Selecione...</option>
            </select>
            <input type="text" id="new-integrator" placeholder="Nome da nova integradora" style="display: none; margin-top: 8px;" />
          </div>
          
          <div class="form-group">
            <label for="project-assembler">Montador</label>
            <select id="project-assembler" onchange="handleNewOption('assembler')">
              <option value="">Selecione...</option>
            </select>
            <input type="text" id="new-assembler" placeholder="Nome do novo montador" style="display: none; margin-top: 8px;" />
          </div>
          
          <div class="form-group">
            <label for="project-assembler-start-date">Previs√£o In√≠cio Montagem</label>
            <input type="date" id="project-assembler-start-date" />
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label for="project-electrician">Eletricista</label>
            <select id="project-electrician" onchange="handleNewOption('electrician')">
              <option value="">Selecione...</option>
            </select>
            <input type="text" id="new-electrician" placeholder="Nome do novo eletricista" style="display: none; margin-top: 8px;" />
          </div>
          
          <div class="form-group">
            <label for="project-electrician-start-date">Previs√£o In√≠cio El√©trica</label>
            <input type="date" id="project-electrician-start-date" />
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label for="project-start-date">Previs√£o In√≠cio</label>
            <input type="date" id="project-start-date" />
          </div>
          
          <div class="form-group">
            <label for="project-delivery">Previs√£o de Entrega</label>
            <input type="date" id="project-delivery" />
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label for="project-location">Localiza√ß√£o (Endere√ßo)</label>
            <div style="display: flex; gap: 8px;">
              <input type="text" id="project-location" placeholder="Endere√ßo da obra" style="flex: 1;" />
              <button type="button" onclick="openMapSelector('project-location')" style="padding: 8px 16px; background: #27ae60; color: white; border: none; border-radius: 4px; cursor: pointer; white-space: nowrap; font-size: 14px;" title="Selecionar no Mapa">
                üó∫Ô∏è Mapa
              </button>
              <button type="button" onclick="openLocationInMaps()" style="padding: 8px 16px; background: #4285f4; color: white; border: none; border-radius: 4px; cursor: pointer; white-space: nowrap; font-size: 14px;" title="Abrir no Google Maps">
                üìç Maps
              </button>
            </div>
            <input type="hidden" id="project-location-lat" />
            <input type="hidden" id="project-location-lng" />
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label for="project-gsi-forecast">üì¶ Data Prevista GSI</label>
            <input type="date" id="project-gsi-forecast" title="Data prevista para entrega GSI" />
          </div>
        </div>
        
        <div class="modal-actions">
          <button type="button" class="btn-secondary" onclick="closeProjectModal()">Cancelar</button>
          <button type="submit" class="primary">Criar Obra</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal: Editar Obra -->
  <div class="modal" id="edit-project-modal">
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <h2>Editar Obra</h2>
        <button class="close-modal" onclick="closeEditProjectModal()">&times;</button>
      </div>
      <form id="edit-project-form">
        <input type="hidden" id="edit-project-id" />
        
        <div class="form-row">
          <div class="form-group">
            <label for="edit-project-client">Cliente *</label>
            <input type="text" id="edit-project-client" required placeholder="Nome do cliente" />
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label for="edit-project-store">Loja *</label>
            <select id="edit-project-store" required>
              <option value="">Selecione...</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="edit-project-city">Cidade</label>
            <input type="text" id="edit-project-city" placeholder="Cidade da obra" />
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label for="edit-project-status">Status *</label>
            <select id="edit-project-status" required>
              <option value="">Selecione...</option>
            </select>
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label for="edit-project-integrator">Integradora</label>
            <select id="edit-project-integrator" onchange="handleNewOption('integrator', 'edit')">
              <option value="">Selecione...</option>
            </select>
            <input type="text" id="edit-new-integrator" placeholder="Nome da nova integradora" style="display: none; margin-top: 8px;" />
          </div>
          
          <div class="form-group">
            <label for="edit-project-assembler">Montador</label>
            <select id="edit-project-assembler" onchange="handleNewOption('assembler', 'edit')">
              <option value="">Selecione...</option>
            </select>
            <input type="text" id="edit-new-assembler" placeholder="Nome do novo montador" style="display: none; margin-top: 8px;" />
          </div>
          
          <div class="form-group">
            <label for="edit-project-assembler-start-date">Previs√£o In√≠cio Montagem</label>
            <input type="date" id="edit-project-assembler-start-date" />
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label for="edit-project-electrician">Eletricista</label>
            <select id="edit-project-electrician" onchange="handleNewOption('electrician', 'edit')">
              <option value="">Selecione...</option>
            </select>
            <input type="text" id="edit-new-electrician" placeholder="Nome do novo eletricista" style="display: none; margin-top: 8px;" />
          </div>
          
          <div class="form-group">
            <label for="edit-project-electrician-start-date">Previs√£o In√≠cio El√©trica</label>
            <input type="date" id="edit-project-electrician-start-date" />
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label for="edit-project-start-date">Previs√£o In√≠cio</label>
            <input type="date" id="edit-project-start-date" />
          </div>
          
          <div class="form-group">
            <label for="edit-project-delivery">Previs√£o de Entrega</label>
            <input type="date" id="edit-project-delivery" />
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label for="edit-project-location">Localiza√ß√£o (Endere√ßo)</label>
            <div style="display: flex; gap: 8px;">
              <input type="text" id="edit-project-location" placeholder="Endere√ßo da obra" style="flex: 1;" />
              <button type="button" onclick="openMapSelector('edit-project-location')" style="padding: 8px 16px; background: #27ae60; color: white; border: none; border-radius: 4px; cursor: pointer; white-space: nowrap; font-size: 14px;" title="Selecionar no Mapa">
                üó∫Ô∏è Mapa
              </button>
              <button type="button" onclick="openEditLocationInMaps()" style="padding: 8px 16px; background: #4285f4; color: white; border: none; border-radius: 4px; cursor: pointer; white-space: nowrap; font-size: 14px;" title="Abrir no Google Maps">
                üìç Maps
              </button>
            </div>
            <input type="hidden" id="edit-project-location-lat" />
            <input type="hidden" id="edit-project-location-lng" />
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label for="edit-project-gsi-forecast">üì¶ Data Prevista GSI</label>
            <input type="date" id="edit-project-gsi-forecast" title="Data prevista para entrega GSI" />
          </div>
        </div>
        
        <div class="modal-actions">
          <button type="button" class="btn-secondary" onclick="closeEditProjectModal()">Cancelar</button>
          <button type="submit" class="primary">Salvar Altera√ß√µes</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal de Sele√ß√£o de Localiza√ß√£o no Mapa -->
  <div id="map-modal" class="modal">
    <div class="modal-content" style="width: 90%; max-width: 900px; height: 80vh; display: flex; flex-direction: column;">
      <div class="modal-header">
        <h2>üó∫Ô∏è Selecionar Localiza√ß√£o</h2>
        <button class="modal-close" onclick="closeMapModal()">&times;</button>
      </div>
      
      <div style="padding: 10px 15px; background: #1e293b; display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
        <input type="text" id="map-search-input" placeholder="Buscar cidade ou regi√£o..." 
               style="flex: 1; min-width: 200px; padding: 10px; background: #0f172a; border: 1px solid #334155; border-radius: 6px; color: #ecf0f1; font-size: 14px;" />
        <button type="button" onclick="searchAddress()" 
                style="padding: 10px 20px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
          üîç Buscar
        </button>
        <button type="button" onclick="getCurrentLocation()" 
                style="padding: 10px 20px; background: #27ae60; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
          üìç Minha Localiza√ß√£o
        </button>
      </div>
      
      <div style="padding: 8px 15px; background: #0f172a; color: #9ca3af; font-size: 12px; border-bottom: 1px solid #334155;">
        üí° <strong>Dica:</strong> Para obras no interior sem endere√ßo, busque a cidade e depois clique/arraste o pin para o local exato.
      </div>
      
      <div id="map-container" style="flex: 1; min-height: 300px;"></div>
      
      <div style="padding: 15px; background: #1e293b; border-top: 1px solid #334155;">
        <div style="margin-bottom: 10px;">
          <strong style="color: #3b82f6;">üìç Local Selecionado:</strong>
          <span id="selected-address" style="color: #ecf0f1; margin-left: 10px;">Clique no mapa ou busque uma cidade</span>
        </div>
        <div id="selected-coords" style="font-size: 11px; color: #6b7280; margin-bottom: 10px; display: none;">
          Coordenadas: <span id="coords-display"></span>
        </div>
        <div style="display: flex; gap: 10px; justify-content: flex-end;">
          <button type="button" onclick="closeMapModal()" 
                  style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer;">
            Cancelar
          </button>
          <button type="button" onclick="confirmMapLocation()" 
                  style="padding: 10px 20px; background: #27ae60; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
            ‚úì Confirmar Localiza√ß√£o
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  
  <!-- Script do Mapa -->
  <script>
    // Vari√°veis globais do mapa
    let map = null;
    let marker = null;
    let selectedLocation = { lat: null, lng: null, address: '' };
    let targetInputId = null;

    // Abrir modal do mapa
    window.openMapSelector = function(inputId) {
      targetInputId = inputId;
      const modal = document.getElementById('map-modal');
      modal.classList.add('active');
      
      // Inicializar mapa se ainda n√£o existir
      setTimeout(() => {
        if (!map) {
          initMap();
        } else {
          map.invalidateSize();
        }
        
        // Se j√° tem endere√ßo, tentar localizar
        const currentAddress = document.getElementById(inputId)?.value;
        if (currentAddress) {
          document.getElementById('map-search-input').value = currentAddress;
          searchAddress();
        }
      }, 100);
    };

    // Inicializar mapa Leaflet
    function initMap() {
      // Centro padr√£o: Brasil
      map = L.map('map-container').setView([-15.7801, -47.9292], 4);
      
      // Camada do OpenStreetMap
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors'
      }).addTo(map);
      
      // Clique no mapa para adicionar/mover marcador
      map.on('click', function(e) {
        placeMarker(e.latlng.lat, e.latlng.lng);
        reverseGeocode(e.latlng.lat, e.latlng.lng);
      });
    }

    // Colocar marcador no mapa
    function placeMarker(lat, lng) {
      if (marker) {
        marker.setLatLng([lat, lng]);
      } else {
        marker = L.marker([lat, lng], { draggable: true }).addTo(map);
        
        // Quando arrastar o marcador
        marker.on('dragend', function(e) {
          const pos = e.target.getLatLng();
          reverseGeocode(pos.lat, pos.lng);
        });
      }
      
      selectedLocation.lat = lat;
      selectedLocation.lng = lng;
      map.setView([lat, lng], 15);
      
      // Mostrar coordenadas
      document.getElementById('selected-coords').style.display = 'block';
      document.getElementById('coords-display').textContent = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
    }

    // Buscar endere√ßo (geocoding)
    window.searchAddress = async function() {
      const query = document.getElementById('map-search-input').value.trim();
      if (!query) {
        alert('Digite uma cidade ou regi√£o para buscar');
        return;
      }
      
      try {
        const response = await fetch(
          `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`
        );
        const results = await response.json();
        
        if (results && results.length > 0) {
          const result = results[0];
          placeMarker(parseFloat(result.lat), parseFloat(result.lon));
          selectedLocation.address = result.display_name;
          document.getElementById('selected-address').textContent = result.display_name;
        } else {
          alert('Local n√£o encontrado. Tente buscar pelo nome da cidade.');
        }
      } catch (error) {
        console.error('Erro ao buscar endere√ßo:', error);
        alert('Erro ao buscar endere√ßo');
      }
    };

    // Geocodifica√ß√£o reversa (coordenadas -> endere√ßo)
    async function reverseGeocode(lat, lng) {
      try {
        const response = await fetch(
          `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`
        );
        const result = await response.json();
        
        if (result && result.display_name) {
          selectedLocation.address = result.display_name;
          document.getElementById('selected-address').textContent = result.display_name;
        }
      } catch (error) {
        console.error('Erro na geocodifica√ß√£o reversa:', error);
        selectedLocation.address = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
        document.getElementById('selected-address').textContent = selectedLocation.address;
      }
    }

    // Obter localiza√ß√£o atual
    window.getCurrentLocation = function() {
      if (!navigator.geolocation) {
        alert('Geolocaliza√ß√£o n√£o suportada pelo navegador');
        return;
      }
      
      navigator.geolocation.getCurrentPosition(
        (position) => {
          const lat = position.coords.latitude;
          const lng = position.coords.longitude;
          placeMarker(lat, lng);
          reverseGeocode(lat, lng);
        },
        (error) => {
          alert('N√£o foi poss√≠vel obter sua localiza√ß√£o: ' + error.message);
        }
      );
    };

    // Confirmar localiza√ß√£o selecionada
    window.confirmMapLocation = function() {
      if (!selectedLocation.lat || !selectedLocation.lng) {
        alert('Selecione uma localiza√ß√£o no mapa primeiro');
        return;
      }
      
      // Preencher o campo de endere√ßo (ou coordenadas se n√£o tiver endere√ßo)
      if (targetInputId) {
        const addressValue = selectedLocation.address || 
          `Coordenadas: ${selectedLocation.lat.toFixed(6)}, ${selectedLocation.lng.toFixed(6)}`;
        document.getElementById(targetInputId).value = addressValue;
        
        // Preencher campos de lat/lng se existirem
        const latInput = document.getElementById(targetInputId + '-lat');
        const lngInput = document.getElementById(targetInputId + '-lng');
        if (latInput) latInput.value = selectedLocation.lat;
        if (lngInput) lngInput.value = selectedLocation.lng;
      }
      
      closeMapModal();
    };

    // Fechar modal do mapa
    window.closeMapModal = function() {
      document.getElementById('map-modal').classList.remove('active');
      selectedLocation = { lat: null, lng: null, address: '' };
      document.getElementById('selected-address').textContent = 'Clique no mapa para selecionar';
      document.getElementById('map-search-input').value = '';
    };

    // Permitir busca com Enter
    document.addEventListener('DOMContentLoaded', function() {
      const searchInput = document.getElementById('map-search-input');
      if (searchInput) {
        searchInput.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            e.preventDefault();
            searchAddress();
          }
        });
      }
    });
  </script>

  <script src="/socket.io/socket.io.js"></script>
  <script src="auth.js"></script>
  <script src="app-simple.js"></script>
</body>
</html>